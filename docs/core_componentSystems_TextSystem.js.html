<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/componentSystems/TextSystem.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/componentSystems/TextSystem.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { getSelectionRects, preloadFont } from 'troika-three-text';

import { MRSystem } from 'mrjs/core/MRSystem';
import { MRTextEntity } from 'mrjs/core/MRTextEntity';
import { MREntity } from 'mrjs/core/MREntity';
import { TextField } from 'mrjs/core/entities/TextField';
import { TextArea } from 'mrjs/core/entities/TextArea';

import { mrjsUtils } from 'mrjs';

/**
 * @class TextSystem
 * @classdesc Handles text creation and font rendering for `mr-text`, `mr-textfield`, and `mr-textarea` with a starting framerate of 1/30.
 * @augments MRSystem
 */
export class TextSystem extends MRSystem {
    /**
     * TextSystem's default constructor
     */
    constructor() {
        super(false, 1 / 30);

        this.preloadedFonts = {};

        this.styles = {};
        const styleSheets = Array.from(document.styleSheets);

        styleSheets.forEach((styleSheet) => {
            const cssRules = Array.from(styleSheet.cssRules);
            // all the font-faces rules
            const rulesFontFace = cssRules.filter((rule) => rule.cssText.startsWith('@font-face'));

            rulesFontFace.forEach((fontFace) => {
                const fontData = this.parseFontFace(fontFace.cssText);

                preloadFont(
                    {
                        font: fontData.src,
                    },
                    () => {
                        this.preloadedFonts[fontFace.style.fontFamily] = fontData.src;
                    }
                );
            });
        });

        const entities = this.app.querySelectorAll('mr-text, mr-textfield, mr-textarea');
        for (const entity of entities) {
            this.registry.add(entity);
            this.addText(entity);
            entity.textObj.sync(() => {
                entity.textObj.position.setY(entity.height / 2);
            });
        }
    }

    /**
     * The generic system update call for all text items including updates for style and cleaning of content for special characters.
     * @param {number} deltaTime - given timestep to be used for any feature changes
     * @param {object} frame - given frame information to be used for any feature changes
     */
    update(deltaTime, frame) {
        for (const entity of this.registry) {
            let text;
            if (entity instanceof TextField || entity instanceof TextArea) {
                text = entity.input.value;
                if (entity == document.activeElement) {
                    entity.updateCursorPosition();
                } else {
                    entity.blur();
                }
            } else {
                // troika honors newlines/white space
                // we want to mimic h1, p, etc which do not honor these values
                // so we have to clean these from the text
                // ref: https://github.com/protectwise/troika/issues/289#issuecomment-1841916850
                text = entity.textContent
                    .replace(/(\n)\s+/g, '$1')
                    .replace(/(\r\n|\n|\r)/gm, '')
                    .trim();
            }
            if (entity.textObj.text != text) {
                entity.textObj.text = text.length > 0 ? text : ' ';
                entity.textObj.sync();
            }

            this.updateStyle(entity);
            if (entity.needsUpdate) {
                entity.needsUpdate = false;
                entity.textObj.sync(() => {
                    entity.textObj.position.setY(entity.height / 2);
                });
            }
        }
    }

    /**
     * Updates the style for the text's information based on compStyle and inputted css elements.
     * @param {MRTextEntity} entity - the text entity whose style is being updated
     */
    updateStyleImpl(entity) {
        const { textObj } = entity;

        textObj.font = this.preloadedFonts[entity.compStyle.fontFamily] ?? textObj.font;
        textObj.fontSize = this.parseFontSize(entity.compStyle.fontSize, entity);
        textObj.fontWeight = this.parseFontWeight(entity.compStyle.fontWeight);
        textObj.fontStyle = entity.compStyle.fontStyle;

        textObj.anchorX = 'center';
        textObj.anchorY = this.getVerticalAlign(entity.compStyle.verticalAlign, entity);

        textObj.textAlign = this.getTextAlign(entity.compStyle.textAlign);
        textObj.lineHeight = this.getLineHeight(entity.compStyle.lineHeight, entity);

        textObj.material.opacity = entity.compStyle.opacity ?? 1;

        this.setColor(textObj, entity.compStyle.color);

        textObj.whiteSpace = entity.compStyle.whiteSpace ?? textObj.whiteSpace;
        textObj.maxWidth = entity.width;

        textObj.position.z = 0.0001;
    }
    updateStyle = (entity) => {
        return this.updateStyleImpl(entity);
    };

    /**
     * Handles when text is added as an entity updating content and style for the internal textObj appropriately.
     * @param {MRTextEntity} entity - the text entity being updated
     */
    addTextImpl(entity) {
        const text = entity.textContent.trim();
        entity.textObj.text = text.length > 0 ? text : ' ';

        this.updateStyle(entity);
    }
    addText = (entity) => {
        return this.addTextImpl(entity);
    };

    /**
     * parses the font weight as 'bold', 'normal', etc based on the given weight value
     * @param {number} weight - the numerical representation of the font-weight
     * @returns {string} - the enum of 'bold', 'normal', etc
     */
    parseFontWeight(weight) {
        if (weight >= 500) {
            return 'bold';
        }
        return 'normal';
    }

    /**
     * parses the font size based on its `XXpx` value and converts it to a usable result based on the virtual display resolution
     * @param {number} val - the value being adjusted
     * @param {object} el - the css element handler
     * @returns {number} - the font size adjusted for the display as expected
     */
    parseFontSize(val, el) {
        const result = parseFloat(val.split('px')[0]) / mrjsUtils.Display.VIRTUAL_DISPLAY_RESOLUTION;
        if (global.inXR) {
            return result * el.windowHorizontalScale;
        }
        return result;
    }

    /**
     * Gets the vertical align
     * @param {number} verticalAlign - the numerical representation in pixel space of the vertical Align
     * @param {MREntity} entity - the entity whose comp style (css) is relevant
     * @returns {string} - the string representation of the the verticalAlign
     */
    getVerticalAlign(verticalAlign, entity) {
        let result = mrjsUtils.Css.pxToThree(verticalAlign);

        if (typeof result === 'number') {
            result /= mrjsUtils.Css.pxToThree(entity.compStyle.fontSize);
        }

        switch (result) {
            case 'baseline':
            case 'sub':
            case 'super':
                return 0;
            case 'text-top':
                return 'top-cap';
            case 'text-bottom':
                return 'bottom';
            default:
                return result;
        }
    }

    /**
     * Gets the line height
     * @param {number} lineHeight - the numerical representation in pixel space of the line height
     * @param {MREntity} entity - the entity whose comp style (css) is relevant
     * @returns {number} - the numerical representation of the the lineHeight
     */
    getLineHeight(lineHeight, entity) {
        let result = mrjsUtils.Css.pxToThree(lineHeight);

        if (typeof result === 'number') {
            result /= mrjsUtils.Css.pxToThree(entity.compStyle.fontSize);
        }

        return result;
    }

    /**
     * Gets the text alignment string
     * @param {string} textAlign - handles values for `start`, `end`, `left`, and `right`; otherwise, defaults to the same input as `textAlign`.
     * @returns {string} - the resolved `textAlign`.
     */
    getTextAlign(textAlign) {
        if (textAlign == 'start') {
            return 'left';
        } else if (textAlign == 'end') {
            return 'right';
        }
        return textAlign;
    }

    /**
     * Sets the matrial color and opacity based on the css color element
     * @param {object} textObj - the textObj whose color is being updated
     * @param {object} color - the representation of color as `rgba(xxx,xxx,xxx)` or as `#xxx`
     */
    setColor(textObj, color) {
        if (color.includes('rgba')) {
            const rgba = color
                .substring(5, color.length - 1)
                .split(',')
                .map((part) => parseFloat(part.trim()));
            textObj.material.color.setStyle(`rgb(${rgba[0]}, ${rgba[1]}, ${rgba[2]})`);

            textObj.material.opacity = rgba[3];
        } else {
            textObj.material.color.setStyle(color ?? '#000');
        }
    }

    /**
     * Based on the given font-face value in the passed cssString, tries to either use by default or download the requested font-face
     * for use by the text object.
     * @param {string} cssString - the css string to be parsed for the font-face css value.
     * @returns {object} - json object respresenting the preloaded font-face
     */
    parseFontFace(cssString) {
        const obj = {};
        const match = cssString.match(/@font-face\s*{\s*([^}]*)\s*}/);

        if (match) {
            const fontFaceAttributes = match[1];
            const attributes = fontFaceAttributes.split(';');

            attributes.forEach((attribute) => {
                const [key, value] = attribute.split(':').map((item) => item.trim());
                if (key === 'src') {
                    const urlMatch = value.match(/url\("([^"]+)"\)/);
                    if (urlMatch) {
                        obj[key] = urlMatch[1];
                    }
                } else {
                    obj[key] = value;
                }
            });
        }

        return obj;
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-mrjs.html">mrjs</a></li><li><a href="module-mrjsUtils.html">mrjsUtils</a></li></ul><h3>Classes</h3><ul><li><a href="Button.html">Button</a></li><li><a href="Button_MRDivEntity.html">MRDivEntity</a></li><li><a href="Button_MREntity.html">MREntity</a></li><li><a href="ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingGeometry_ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_MRSystem.html">MRSystem</a></li><li><a href="ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_MRSystem.html">MRSystem</a></li><li><a href="Image.html">Image</a></li><li><a href="Image_Image.html">Image</a></li><li><a href="Image_MRDivEntity.html">MRDivEntity</a></li><li><a href="Image_MREntity.html">MREntity</a></li><li><a href="Instancing%2520System.html">Instancing System</a></li><li><a href="Instancing%2520System_MRSystem.html">MRSystem</a></li><li><a href="InstancingSystem.html">InstancingSystem</a></li><li><a href="Layout%2520System.html">Layout System</a></li><li><a href="Layout%2520System_MRSystem.html">MRSystem</a></li><li><a href="LayoutSystem_LayoutSystem.html">LayoutSystem</a></li><li><a href="Light.html">Light</a></li><li><a href="Light_MRElement.html">MRElement</a></li><li><a href="Light_MREntity.html">MREntity</a></li><li><a href="MRApp.html">MRApp</a></li><li><a href="MRApp_MRApp.html">MRApp</a></li><li><a href="MRApp_MRElement.html">MRElement</a></li><li><a href="MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MREntity.html">MREntity</a></li><li><a href="MRElement.html">MRElement</a></li><li><a href="MRElement_MRElement.html">MRElement</a></li><li><a href="MREntity.html">MREntity</a></li><li><a href="MREntity_MRElement.html">MRElement</a></li><li><a href="MREntity_MREntity.html">MREntity</a></li><li><a href="MRHand.html">MRHand</a></li><li><a href="MRHand_MRHand.html">MRHand</a></li><li><a href="MRSystem.html">MRSystem</a></li><li><a href="MRSystem_MRSystem.html">MRSystem</a></li><li><a href="MRTextArea.html">MRTextArea</a></li><li><a href="MRTextArea_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextArea_MREntity.html">MREntity</a></li><li><a href="MRTextArea_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextEntity_MREntity.html">MREntity</a></li><li><a href="MRTextEntity_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextField.html">MRTextField</a></li><li><a href="MRTextField_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextField_MREntity.html">MREntity</a></li><li><a href="MRTextField_MRTextEntity.html">MRTextEntity</a></li><li><a href="Model.html">Model</a></li><li><a href="Model_MRElement.html">MRElement</a></li><li><a href="Model_MREntity.html">MREntity</a></li><li><a href="Model_Model.html">Model</a></li><li><a href="Panel.html">Panel</a></li><li><a href="Panel_MRDivEntity.html">MRDivEntity</a></li><li><a href="Panel_MREntity.html">MREntity</a></li><li><a href="Panel_Panel.html">Panel</a></li><li><a href="PhysicsSystem.html">PhysicsSystem</a></li><li><a href="PhysicsSystem_MRSystem.html">MRSystem</a></li><li><a href="PhysicsSystem_PhysicsSystem.html">PhysicsSystem</a></li><li><a href="SkyBox.html">SkyBox</a></li><li><a href="SkyBox_MRElement.html">MRElement</a></li><li><a href="SkyBox_MREntity.html">MREntity</a></li><li><a href="StyleSystem.html">StyleSystem</a></li><li><a href="StyleSystem_MRSystem.html">MRSystem</a></li><li><a href="StyleSystem_StyleSystem.html">StyleSystem</a></li><li><a href="Surface.html">Surface</a></li><li><a href="Surface_MRElement.html">MRElement</a></li><li><a href="Surface_MREntity.html">MREntity</a></li><li><a href="Surface_Surface.html">Surface</a></li><li><a href="SurfaceSystem.html">SurfaceSystem</a></li><li><a href="SurfaceSystem_MRSystem.html">MRSystem</a></li><li><a href="SurfaceSystem_SurfaceSystem.html">SurfaceSystem</a></li><li><a href="TextArea_TextArea.html">TextArea</a></li><li><a href="TextField_TextField.html">TextField</a></li><li><a href="TextSystem.html">TextSystem</a></li><li><a href="TextSystem_MRSystem.html">MRSystem</a></li><li><a href="TextSystem_TextSystem.html">TextSystem</a></li><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#UIPlane">UIPlane</a></li><li><a href="global.html#computeBoundingSphere">computeBoundingSphere</a></li><li><a href="global.html#connected">connected</a></li><li><a href="global.html#jsonToString">jsonToString</a></li><li><a href="global.html#loadDAE">loadDAE</a></li><li><a href="global.html#loadFBX">loadFBX</a></li><li><a href="global.html#loadGLTF">loadGLTF</a></li><li><a href="global.html#loadModel">loadModel</a></li><li><a href="global.html#loadSTL">loadSTL</a></li><li><a href="global.html#loadUSDZ">loadUSDZ</a></li><li><a href="global.html#mobileCheckFunction">mobileCheckFunction</a></li><li><a href="global.html#mutatedImpl">mutatedImpl</a></li><li><a href="global.html#onHoverImpl">onHoverImpl</a></li><li><a href="global.html#pxToThree">pxToThree</a></li><li><a href="global.html#radToDeg">radToDeg</a></li><li><a href="global.html#roundTo">roundTo</a></li><li><a href="global.html#roundVectorTo">roundVectorTo</a></li><li><a href="global.html#stringToDegVector">stringToDegVector</a></li><li><a href="global.html#stringToDimensionValue">stringToDimensionValue</a></li><li><a href="global.html#stringToJson">stringToJson</a></li><li><a href="global.html#stringToVector">stringToVector</a></li><li><a href="global.html#threeToPx">threeToPx</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Dec 14 2023 06:31:58 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
