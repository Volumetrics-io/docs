<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: core/componentSystems/SurfaceSystem.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: core/componentSystems/SurfaceSystem.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as THREE from 'three';

import { MRSystem } from 'mrjs/core/MRSystem';

// TODO - michael redoing as part of the anchor/surface change
/**
 * @class SurfaceSystem
 * @classdesc Handles all items (3D and 2D) associated with an mr-surface including the surface itself.
 * @augments MRSystem
 */
export class SurfaceSystem extends MRSystem {
    /**
     * SurfaceSystem's default constructor including setting up /...? TODO - i need to understand what an mr-surface is first
     */
    constructor() {
        super(false);
        this.referenceSpace;
        this.sourceRequest = false;
        this.source;
        this.currentSurface = null;
        this.tempMatrix = new THREE.Matrix4();

        this.userWorldPosition = new THREE.Vector3();
        this.cameraForward = new THREE.Vector3();
        this.pinchDistance = 0;

        this.hand = null;

        this.snapDistance = 0.6;

        this.scale = 1;

        const entities = this.app.querySelectorAll('mr-surface');

        for (const surface of entities) {
            this.registry.add(surface);
            surface.group.visible = false;
            surface.rotationPlane.rotation.x = 3 * (Math.PI / 2);
        }

        document.addEventListener('pinchstart', (event) => {
            if (this.currentSurface == null || (this.hand &amp;&amp; this.hand != event.detail.handedness)) {
                return;
            }
            this.pinchDistance = this.cameraForward.distanceTo(event.detail.position);
            if (this.pinchDistance &lt; 0.3) {
                this.hand = event.detail.handedness;
            }
        });

        document.addEventListener('pinchmoved', (event) => {
            this.pinchDistance = this.cameraForward.distanceTo(event.detail.position);
            if (this.currentSurface &amp;&amp; this.hand == event.detail.handedness) {
                this.scale = Math.exp(2 * this.pinchDistance);
                this.app.anchor.position.z = this.app.forward.position.z * this.scale;
                this.currentSurface.viz.scale.setScalar(this.scale);
            }
        });

        document.addEventListener('pinchend', (event) => {
            if (this.currentSurface == null || this.hand != event.detail.handedness) {
                return;
            }
            this.lockWindow();

            this.hand = null;
            this.app.anchor.position.z = this.app.forward.position.z;
        });
    }

    /**
     * The generic system update call.
     * // TODO - add better description here
     * @param {number} deltaTime - given timestep to be used for any feature changes
     * @param {object} frame - given frame information to be used for any feature changes
     */
    update(deltaTime, frame) {
        if (this.registry.size == 0) {
            return;
        }
        for (const surface of this.registry) {
            if (this.currentSurface == null &amp;&amp; surface.anchored == false) {
                this.currentSurface = surface;
            } else if (surface.anchored &amp;&amp; !surface.placed) {
                if (!global.inXR) {
                    return;
                }
                surface.replace();
            }
        }

        if (this.sourceRequest == false) {
            this.referenceSpace = this.app.renderer.xr.getReferenceSpace();

            this.session = this.app.renderer.xr.getSession();

            this.session.requestReferenceSpace('viewer').then((referenceSpace) => {
                this.session.requestHitTestSource({ space: referenceSpace }).then((source) => {
                    this.source = source;
                });
            });

            this.session.addEventListener('end', () => {
                global.inXR = false;
                this.app.user.position.set(0, 0, 1);
                this.app.user.quaternion.set(0, 0, 0, 1);
                this.resetAllSurfaces();

                this.sourceRequest = false;
                this.source = null;
            });

            this.sourceRequest = true;
        }
        if (this.currentSurface == null) {
            return;
        }
        if (this.source) {
            const results = frame.getHitTestResults(this.source);
            this.placeSurface(results, frame);
        }
    }

    /**
     * Detaches all surfaces in this system and resets them
     */
    resetAllSurfaces() {
        for (const surface of this.registry) {
            surface.detach();
        }
    }

    /**
     * Locks the window in place where it has been positioned after being moved.
     */
    lockWindow() {
        this.currentSurface.windowVerticalScale = this.scale * global.XRScale * this.currentSurface.height;
        this.currentSurface.windowHorizontalScale = this.scale * global.XRScale * this.currentSurface.width;
        this.currentSurface.place();

        this.currentSurface.anchorPosition.copy(this.currentSurface.object3D.position);
        this.currentSurface.anchorQuaternion.copy(this.currentSurface.object3D.quaternion);

        this.currentSurface.anchored = true;

        this.currentSurface = null;
    }

    /**
     * Places the surface based on the user's current pose position??? TODO
     * @param {object} hitResults - TODO
     * @param {object} frame - TODO
     */
    placeSurface(hitResults, frame) {
        if (!this.currentSurface.viz.visible) {
            this.currentSurface.viz.visible = true;
        }

        const hit = hitResults[0];
        const pose = hit?.getPose(this.referenceSpace);
        this.userWorldPosition.setFromMatrixPosition(this.app.user.matrixWorld);
        this.cameraForward.setFromMatrixPosition(this.app.forward.matrixWorld);

        if (pose &amp;&amp; this.userWorldPosition.distanceTo(pose.transform.position) &lt; this.snapDistance * this.scale) {
            this.currentSurface.rotationPlane.rotation.x = (3 * Math.PI) / 2;
            this.currentSurface.floating = false;

            this.currentSurface.object3D.position.fromArray([pose.transform.position.x, pose.transform.position.y, pose.transform.position.z]);
            this.currentSurface.object3D.quaternion.fromArray([
                pose.transform.orientation.x,
                pose.transform.orientation.y,
                pose.transform.orientation.z,
                pose.transform.orientation.w,
            ]);
        } else {
            this.currentSurface.floating = true;
            this.currentSurface.rotationPlane.rotation.x = 0;
            this.currentSurface.object3D.position.setFromMatrixPosition(this.app.anchor.matrixWorld);
            this.currentSurface.object3D.lookAt(this.app.user.position);

            if (this.currentSurface.getAttribute('fixed')) {
                this.lockWindow();
            }
        }
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-mrjs.html">mrjs</a></li><li><a href="module-mrjsUtils.html">mrjsUtils</a></li></ul><h3>Classes</h3><ul><li><a href="Button.html">Button</a></li><li><a href="Button_MRDivEntity.html">MRDivEntity</a></li><li><a href="Button_MREntity.html">MREntity</a></li><li><a href="ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingGeometry_ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_MRSystem.html">MRSystem</a></li><li><a href="ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_MRSystem.html">MRSystem</a></li><li><a href="Image.html">Image</a></li><li><a href="Image_Image.html">Image</a></li><li><a href="Image_MRDivEntity.html">MRDivEntity</a></li><li><a href="Image_MREntity.html">MREntity</a></li><li><a href="Instancing%2520System.html">Instancing System</a></li><li><a href="Instancing%2520System_MRSystem.html">MRSystem</a></li><li><a href="InstancingSystem.html">InstancingSystem</a></li><li><a href="Layout%2520System.html">Layout System</a></li><li><a href="Layout%2520System_MRSystem.html">MRSystem</a></li><li><a href="LayoutSystem_LayoutSystem.html">LayoutSystem</a></li><li><a href="Light.html">Light</a></li><li><a href="Light_MRElement.html">MRElement</a></li><li><a href="Light_MREntity.html">MREntity</a></li><li><a href="MRApp.html">MRApp</a></li><li><a href="MRApp_MRApp.html">MRApp</a></li><li><a href="MRApp_MRElement.html">MRElement</a></li><li><a href="MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MREntity.html">MREntity</a></li><li><a href="MRElement.html">MRElement</a></li><li><a href="MRElement_MRElement.html">MRElement</a></li><li><a href="MREntity.html">MREntity</a></li><li><a href="MREntity_MRElement.html">MRElement</a></li><li><a href="MREntity_MREntity.html">MREntity</a></li><li><a href="MRHand.html">MRHand</a></li><li><a href="MRHand_MRHand.html">MRHand</a></li><li><a href="MRSystem.html">MRSystem</a></li><li><a href="MRSystem_MRSystem.html">MRSystem</a></li><li><a href="MRTextArea.html">MRTextArea</a></li><li><a href="MRTextArea_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextArea_MREntity.html">MREntity</a></li><li><a href="MRTextArea_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextEntity_MREntity.html">MREntity</a></li><li><a href="MRTextEntity_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextField.html">MRTextField</a></li><li><a href="MRTextField_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextField_MREntity.html">MREntity</a></li><li><a href="MRTextField_MRTextEntity.html">MRTextEntity</a></li><li><a href="Model.html">Model</a></li><li><a href="Model_MRElement.html">MRElement</a></li><li><a href="Model_MREntity.html">MREntity</a></li><li><a href="Model_Model.html">Model</a></li><li><a href="Panel.html">Panel</a></li><li><a href="Panel_MRDivEntity.html">MRDivEntity</a></li><li><a href="Panel_MREntity.html">MREntity</a></li><li><a href="Panel_Panel.html">Panel</a></li><li><a href="PhysicsSystem.html">PhysicsSystem</a></li><li><a href="PhysicsSystem_MRSystem.html">MRSystem</a></li><li><a href="PhysicsSystem_PhysicsSystem.html">PhysicsSystem</a></li><li><a href="SkyBox.html">SkyBox</a></li><li><a href="SkyBox_MRElement.html">MRElement</a></li><li><a href="SkyBox_MREntity.html">MREntity</a></li><li><a href="StyleSystem.html">StyleSystem</a></li><li><a href="StyleSystem_MRSystem.html">MRSystem</a></li><li><a href="StyleSystem_StyleSystem.html">StyleSystem</a></li><li><a href="Surface.html">Surface</a></li><li><a href="Surface_MRElement.html">MRElement</a></li><li><a href="Surface_MREntity.html">MREntity</a></li><li><a href="Surface_Surface.html">Surface</a></li><li><a href="SurfaceSystem.html">SurfaceSystem</a></li><li><a href="SurfaceSystem_MRSystem.html">MRSystem</a></li><li><a href="SurfaceSystem_SurfaceSystem.html">SurfaceSystem</a></li><li><a href="TextArea_TextArea.html">TextArea</a></li><li><a href="TextField_TextField.html">TextField</a></li><li><a href="TextSystem.html">TextSystem</a></li><li><a href="TextSystem_MRSystem.html">MRSystem</a></li><li><a href="TextSystem_TextSystem.html">TextSystem</a></li><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#UIPlane">UIPlane</a></li><li><a href="global.html#computeBoundingSphere">computeBoundingSphere</a></li><li><a href="global.html#connected">connected</a></li><li><a href="global.html#jsonToString">jsonToString</a></li><li><a href="global.html#loadDAE">loadDAE</a></li><li><a href="global.html#loadFBX">loadFBX</a></li><li><a href="global.html#loadGLTF">loadGLTF</a></li><li><a href="global.html#loadModel">loadModel</a></li><li><a href="global.html#loadSTL">loadSTL</a></li><li><a href="global.html#loadUSDZ">loadUSDZ</a></li><li><a href="global.html#mobileCheckFunction">mobileCheckFunction</a></li><li><a href="global.html#mutatedImpl">mutatedImpl</a></li><li><a href="global.html#onHoverImpl">onHoverImpl</a></li><li><a href="global.html#pxToThree">pxToThree</a></li><li><a href="global.html#radToDeg">radToDeg</a></li><li><a href="global.html#roundTo">roundTo</a></li><li><a href="global.html#roundVectorTo">roundVectorTo</a></li><li><a href="global.html#stringToDegVector">stringToDegVector</a></li><li><a href="global.html#stringToDimensionValue">stringToDimensionValue</a></li><li><a href="global.html#stringToJson">stringToJson</a></li><li><a href="global.html#stringToVector">stringToVector</a></li><li><a href="global.html#threeToPx">threeToPx</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Dec 14 2023 22:30:11 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
