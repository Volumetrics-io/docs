<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: datatypes/Hand.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: datatypes/Hand.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import * as THREE from 'three';
import { XRControllerModelFactory } from 'three/addons/webxr/XRControllerModelFactory.js';
import { XRHandModelFactory } from 'three/addons/webxr/XRHandModelFactory.js';

import { mrjsUtils } from 'mrjs';

const HOVER_DISTANCE = 0.05;
const PINCH_DISTANCE = 0.005;

const joints = [
    'wrist',
    'thumb-metacarpal',
    'thumb-phalanx-proximal',
    'thumb-phalanx-distal',
    'thumb-tip',
    'index-finger-metacarpal',
    'index-finger-phalanx-proximal',
    'index-finger-phalanx-intermediate',
    'index-finger-phalanx-distal',
    'index-finger-tip',
    'middle-finger-metacarpal',
    'middle-finger-phalanx-proximal',
    'middle-finger-phalanx-intermediate',
    'middle-finger-phalanx-distal',
    'middle-finger-tip',
    'ring-finger-metacarpal',
    'ring-finger-phalanx-proximal',
    'ring-finger-phalanx-intermediate',
    'ring-finger-phalanx-distal',
    'ring-finger-tip',
    'pinky-finger-metacarpal',
    'pinky-finger-phalanx-proximal',
    'pinky-finger-phalanx-intermediate',
    'pinky-finger-phalanx-distal',
    'pinky-finger-tip',
];

const HAND_MAPPING = {
    left: 0,
    right: 1,
};

/**
 * @class MRHand
 * @classdesc Class describing the MRHand object representing the UX of the hand object for MR interactions.
 */
export class MRHand {
    /**
     * Constructor for the MRHand class object. Setups up all attributes for MRHand including physics, mouse/cursor information, hand tracking and state, and model information.
     * @param {object} handedness - enum for the `left`` or `right` hand.
     * @param {object} app - the current MRApp that contains the scene for the hand.
     */
    constructor(handedness, app) {
        this.handedness = handedness;
        this.pinch = false;
        this.hover = false;

        this.cursorPosition = new THREE.Vector3();

        this.jointPhysicsBodies = {};

        this.identityPosition = new THREE.Vector3();

        this.tempJointPosition = new THREE.Vector3();
        this.tempJointOrientation = new THREE.Quaternion();

        this.orientationOffset = new THREE.Quaternion(0.7071068, 0, 0, 0.7071068);

        this.hoverInitPosition = new THREE.Vector3();
        this.hoverPosition = new THREE.Vector3();

        this.controllerModelFactory = new XRControllerModelFactory();
        this.handModelFactory = new XRHandModelFactory();

        this.mesh;
        this.controller = app.renderer.xr.getController(HAND_MAPPING[handedness]);

        this.grip = app.renderer.xr.getControllerGrip(HAND_MAPPING[handedness]);
        this.grip.add(this.controllerModelFactory.createControllerModel(this.grip));

        this.hand = app.renderer.xr.getHand(HAND_MAPPING[handedness]);
        this.model = this.handModelFactory.createHandModel(this.hand, 'mesh');

        this.hand.add(this.model);

        this.hand.addEventListener('pinchstart', this.onPinch);
        this.hand.addEventListener('pinchend', this.onPinch);

        app.scene.add(this.controller);
        app.scene.add(this.grip);
        app.scene.add(this.hand);
        this.initPhysicsBodies(app);
    }

    /**
     * Initializes the physics bodies that the hand represents. Useful for collision detection and UX interactions in MR space.
     * @param {object} app - the current MRApp that contains the scene for the hand.
     */
    initPhysicsBodies(app) {
        for (const joint of joints) {
            this.tempJointPosition = this.getJointPosition(joint);
            this.tempJointOrientation = this.getJointOrientation(joint);
            const rigidBodyDesc = mrjsUtils.Physics.RAPIER.RigidBodyDesc.kinematicPositionBased().setTranslation(...this.tempJointPosition);

            let colliderDesc;

            if (joint.includes('tip')) {
                colliderDesc = mrjsUtils.Physics.RAPIER.ColliderDesc.ball(0.015);
            } else {
                colliderDesc = mrjsUtils.Physics.RAPIER.ColliderDesc.capsule(0.01, 0.01);
            }

            this.jointPhysicsBodies[joint] = { body: app.physicsWorld.createRigidBody(rigidBodyDesc) };
            this.jointPhysicsBodies[joint].body.setRotation(...this.tempJointOrientation);

            this.jointPhysicsBodies[joint].collider = app.physicsWorld.createCollider(colliderDesc, this.jointPhysicsBodies[joint].body);

            this.jointPhysicsBodies[joint].body.enableCcd(true);

            // RAPIER.ActiveCollisionTypes.KINEMATIC_KINEMATIC for joint to joint collisions
            this.jointPhysicsBodies[joint].collider.setActiveCollisionTypes(
                mrjsUtils.Physics.RAPIER.ActiveCollisionTypes.DEFAULT | mrjsUtils.Physics.RAPIER.ActiveCollisionTypes.KINEMATIC_FIXED
            );
            this.jointPhysicsBodies[joint].collider.setActiveEvents(mrjsUtils.Physics.RAPIER.ActiveEvents.COLLISION_EVENTS);

            if (joint.includes('index-finger-tip')) {
                this.jointPhysicsBodies[`${joint}-hover`] = { body: app.physicsWorld.createRigidBody(rigidBodyDesc) };
                this.jointPhysicsBodies[`${joint}-hover`].body.setRotation(...this.tempJointOrientation);

                // This should be replaced with a cone or something
                const hoverColDesc = mrjsUtils.Physics.RAPIER.ColliderDesc.ball(0.03);
                this.jointPhysicsBodies[`${joint}-hover`].collider = app.physicsWorld.createCollider(hoverColDesc, this.jointPhysicsBodies[`${joint}-hover`].body);
                mrjsUtils.Physics.INPUT_COLLIDER_HANDLE_NAMES[this.jointPhysicsBodies[joint].collider.handle] = joint;
                mrjsUtils.Physics.INPUT_COLLIDER_HANDLE_NAMES[this.jointPhysicsBodies[`${joint}-hover`].collider.handle] = `${joint}-hover`;
            }
        }
    }

    /**
     * Update function for the Hand object. Updates the physics bodies and checks whether a pinch has happened or is in progress in any way.
     */
    update() {
        this.updatePhysicsBodies();
        this.pinchMoved();
    }

    /**
     * If a pinch happens, updates the MR cursor position while sending out an event that movement has occured from this hand.
     */
    pinchMoved() {
        if (!this.pinch) {
            return;
        }
        const position = this.getCursorPosition();
        document.dispatchEvent(
            new CustomEvent('pinchmoved', {
                bubbles: true,
                detail: {
                    handedness: this.handedness,
                    position,
                },
            })
        );
    }

    /**
     * Update function for the physics associated with this hand. Runs for every joint in the system and moves all elements of the hand model.
     */
    updatePhysicsBodies() {
        for (const joint of joints) {
            this.tempJointPosition = this.getJointPosition(joint);
            this.tempJointOrientation = this.getJointOrientation(joint);

            if (!joint.includes('tip')) {
                this.tempJointOrientation.multiply(this.orientationOffset);
            }

            this.jointPhysicsBodies[joint].body.setTranslation({ ...this.tempJointPosition }, true);
            this.jointPhysicsBodies[joint].body.setRotation(this.tempJointOrientation, true);

            if (joint.includes('index-finger-tip')) {
                this.jointPhysicsBodies[`${joint}-hover`].body.setTranslation({ ...this.tempJointPosition }, true);
                this.jointPhysicsBodies[`${joint}-hover`].body.setRotation(this.tempJointOrientation, true);
            }
        }
    }

    /**
     * Handles the setMesh callback.
     */
    setMeshImpl() {
        if (this.mesh) {
            return;
        }
        this.mesh = this.hand.getObjectByProperty('type', 'SkinnedMesh');
        if (!this.mesh) {
            return;
        }
        this.mesh.material.colorWrite = false;
        this.mesh.renderOrder = 2;
    }
    setMesh = () => {
        return this.setMeshImpl();
    };

    /**
     * Handles the onPinch event
     * @param {event} event - the on pinch event object
     */
    onPinchImpl(event) {
        this.pinch = event.type == 'pinchstart';
        const position = this.getCursorPosition();
        document.dispatchEvent(
            new CustomEvent(event.type, {
                bubbles: true,
                detail: {
                    handedness: this.handedness,
                    position,
                },
            })
        );
    }
    onPinch = (event) => {
        return this.onPinchImpl(event);
    };

    /**
     * Gets the joint orientation of the named joint in the hand.
     * @param {string} jointName - the string name of the joint whose information is requested.
     * @returns {THREE.Quaternion} - the quaternion representation or the joint orientation.
     */
    getJointOrientation(jointName) {
        const result = new THREE.Quaternion();

        if (!this.mesh) {
            return result;
        }
        const joint = this.mesh.skeleton.getBoneByName(jointName);

        if (joint == null) {
            return result;
        }

        joint.getWorldQuaternion(result);

        return result;
    }

    /**
     * Gets the joint position of the named joint in the hand.
     * @param {string} jointName - the string name of the joint whose information is requested.
     * @returns {THREE.Vector3} - the position representation or the joint orientation.
     */
    getJointPosition(jointName) {
        const result = new THREE.Vector3();

        // Using an offset value with rapier to throw the items into the distance when inactive since there
        // is no way at the moment to remove them when inactive.
        const offset = 10000;

        if (!this.mesh) {
            result.addScalar(offset);
            return result;
        }
        const joint = this.mesh.skeleton.getBoneByName(jointName);

        if (joint == null) {
            result.addScalar(offset);
            return result;
        }

        joint.getWorldPosition(result);

        if (result.equals(this.identityPosition)) {
            result.addScalar(offset);
        }

        return result;
    }

    /**
     * Gets the expected cursor position of this hand based on the index finger and thumb's tip positions.
     * @returns {number} - the resolved position of the cursor.
     */
    getCursorPosition() {
        const index = this.getJointPosition('index-finger-tip');
        const thumb = this.getJointPosition('thumb-tip');
        return index.lerp(thumb, 0.5);
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-mrjs.html">mrjs</a></li><li><a href="module-mrjsUtils.html">mrjsUtils</a></li></ul><h3>Classes</h3><ul><li><a href="Button.html">Button</a></li><li><a href="Button_MRDivEntity.html">MRDivEntity</a></li><li><a href="Button_MREntity.html">MREntity</a></li><li><a href="ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingGeometry_ClippingGeometry.html">ClippingGeometry</a></li><li><a href="ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_ClippingSystem.html">ClippingSystem</a></li><li><a href="ClippingSystem_MRSystem.html">MRSystem</a></li><li><a href="ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_ControlSystem.html">ControlSystem</a></li><li><a href="ControlSystem_MRSystem.html">MRSystem</a></li><li><a href="Image.html">Image</a></li><li><a href="Image_Image.html">Image</a></li><li><a href="Image_MRDivEntity.html">MRDivEntity</a></li><li><a href="Image_MREntity.html">MREntity</a></li><li><a href="Instancing%2520System.html">Instancing System</a></li><li><a href="Instancing%2520System_MRSystem.html">MRSystem</a></li><li><a href="InstancingSystem.html">InstancingSystem</a></li><li><a href="Layout%2520System.html">Layout System</a></li><li><a href="Layout%2520System_MRSystem.html">MRSystem</a></li><li><a href="LayoutSystem_LayoutSystem.html">LayoutSystem</a></li><li><a href="Light.html">Light</a></li><li><a href="Light_MRElement.html">MRElement</a></li><li><a href="Light_MREntity.html">MREntity</a></li><li><a href="MRApp.html">MRApp</a></li><li><a href="MRApp_MRApp.html">MRApp</a></li><li><a href="MRApp_MRElement.html">MRElement</a></li><li><a href="MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRDivEntity_MREntity.html">MREntity</a></li><li><a href="MRElement.html">MRElement</a></li><li><a href="MRElement_MRElement.html">MRElement</a></li><li><a href="MREntity.html">MREntity</a></li><li><a href="MREntity_MRElement.html">MRElement</a></li><li><a href="MREntity_MREntity.html">MREntity</a></li><li><a href="MRHand.html">MRHand</a></li><li><a href="MRHand_MRHand.html">MRHand</a></li><li><a href="MRSystem.html">MRSystem</a></li><li><a href="MRSystem_MRSystem.html">MRSystem</a></li><li><a href="MRTextArea.html">MRTextArea</a></li><li><a href="MRTextArea_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextArea_MREntity.html">MREntity</a></li><li><a href="MRTextArea_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextEntity_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextEntity_MREntity.html">MREntity</a></li><li><a href="MRTextEntity_MRTextEntity.html">MRTextEntity</a></li><li><a href="MRTextField.html">MRTextField</a></li><li><a href="MRTextField_MRDivEntity.html">MRDivEntity</a></li><li><a href="MRTextField_MREntity.html">MREntity</a></li><li><a href="MRTextField_MRTextEntity.html">MRTextEntity</a></li><li><a href="Model.html">Model</a></li><li><a href="Model_MRElement.html">MRElement</a></li><li><a href="Model_MREntity.html">MREntity</a></li><li><a href="Model_Model.html">Model</a></li><li><a href="Panel.html">Panel</a></li><li><a href="Panel_MRDivEntity.html">MRDivEntity</a></li><li><a href="Panel_MREntity.html">MREntity</a></li><li><a href="Panel_Panel.html">Panel</a></li><li><a href="PhysicsSystem.html">PhysicsSystem</a></li><li><a href="PhysicsSystem_MRSystem.html">MRSystem</a></li><li><a href="PhysicsSystem_PhysicsSystem.html">PhysicsSystem</a></li><li><a href="SkyBox.html">SkyBox</a></li><li><a href="SkyBox_MRElement.html">MRElement</a></li><li><a href="SkyBox_MREntity.html">MREntity</a></li><li><a href="StyleSystem.html">StyleSystem</a></li><li><a href="StyleSystem_MRSystem.html">MRSystem</a></li><li><a href="StyleSystem_StyleSystem.html">StyleSystem</a></li><li><a href="Surface.html">Surface</a></li><li><a href="Surface_MRElement.html">MRElement</a></li><li><a href="Surface_MREntity.html">MREntity</a></li><li><a href="Surface_Surface.html">Surface</a></li><li><a href="SurfaceSystem.html">SurfaceSystem</a></li><li><a href="SurfaceSystem_MRSystem.html">MRSystem</a></li><li><a href="SurfaceSystem_SurfaceSystem.html">SurfaceSystem</a></li><li><a href="TextArea_TextArea.html">TextArea</a></li><li><a href="TextField_TextField.html">TextField</a></li><li><a href="TextSystem.html">TextSystem</a></li><li><a href="TextSystem_MRSystem.html">MRSystem</a></li><li><a href="TextSystem_TextSystem.html">TextSystem</a></li><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Global</h3><ul><li><a href="global.html#UIPlane">UIPlane</a></li><li><a href="global.html#computeBoundingSphere">computeBoundingSphere</a></li><li><a href="global.html#connected">connected</a></li><li><a href="global.html#jsonToString">jsonToString</a></li><li><a href="global.html#loadDAE">loadDAE</a></li><li><a href="global.html#loadFBX">loadFBX</a></li><li><a href="global.html#loadGLTF">loadGLTF</a></li><li><a href="global.html#loadModel">loadModel</a></li><li><a href="global.html#loadSTL">loadSTL</a></li><li><a href="global.html#loadUSDZ">loadUSDZ</a></li><li><a href="global.html#mobileCheckFunction">mobileCheckFunction</a></li><li><a href="global.html#mutatedImpl">mutatedImpl</a></li><li><a href="global.html#onHoverImpl">onHoverImpl</a></li><li><a href="global.html#pxToThree">pxToThree</a></li><li><a href="global.html#radToDeg">radToDeg</a></li><li><a href="global.html#roundTo">roundTo</a></li><li><a href="global.html#roundVectorTo">roundVectorTo</a></li><li><a href="global.html#stringToDegVector">stringToDegVector</a></li><li><a href="global.html#stringToDimensionValue">stringToDimensionValue</a></li><li><a href="global.html#stringToJson">stringToJson</a></li><li><a href="global.html#stringToVector">stringToVector</a></li><li><a href="global.html#threeToPx">threeToPx</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Thu Dec 14 2023 06:31:58 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
